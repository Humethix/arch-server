# ============================================================================
# ARCH SERVER v5.1 - TEST ENVIRONMENT
# Docker image for syntax validation and linting (NOT for actual installation)
# ============================================================================
#
# This container tests everything that CAN be tested without real hardware:
# - Shell script syntax (bash -n)
# - Shellcheck linting
# - Ansible playbook syntax
# - YAML validation
# - Python tests
# - Configuration file validation
#
# USAGE:
#   docker build -f Dockerfile.test -t arch-server-test .
#   docker run --rm arch-server-test
#
# Or with docker-compose:
#   docker-compose -f docker-compose.test.yml up --build
#
# ============================================================================

FROM archlinux:latest

LABEL maintainer="Arch Server v5.1"
LABEL description="Test environment for Arch Server installation scripts"

# Install test dependencies
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
        bash \
        shellcheck \
        ansible \
        ansible-lint \
        python \
        python-pip \
        python-pytest \
        yamllint \
        git \
        && \
    pacman -Scc --noconfirm

# Create test user (non-root for realistic testing)
RUN useradd -m -s /bin/bash testuser

# Set working directory
WORKDIR /app

# Copy project files
COPY --chown=testuser:testuser . /app/

# Make scripts executable
RUN chmod +x /app/src/*.sh /app/scripts/*.sh 2>/dev/null || true

# Create test runner script
RUN cat > /app/run-tests.sh << 'TESTSCRIPT'
#!/bin/bash
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() { echo -e "${BLUE}>>>${NC} $1"; }
success() { echo -e "${GREEN}PASS${NC} $1"; }
fail() { echo -e "${RED}FAIL${NC} $1"; }
warning() { echo -e "${YELLOW}WARN${NC} $1"; }

ERRORS=0
WARNINGS=0

echo ""
echo "================================================================"
echo "  ARCH SERVER v5.1 - TEST SUITE"
echo "================================================================"
echo ""

# ============================================================================
# 1. SHELL SCRIPT SYNTAX
# ============================================================================

log "Testing shell script syntax..."

for script in src/*.sh scripts/*.sh; do
    if [[ -f "$script" ]]; then
        if bash -n "$script" 2>/dev/null; then
            success "$script"
        else
            fail "$script - syntax error"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

echo ""

# ============================================================================
# 2. SHELLCHECK LINTING
# ============================================================================

log "Running shellcheck..."

for script in src/*.sh scripts/*.sh; do
    if [[ -f "$script" ]]; then
        # SC2317: Unreachable code (common in trap handlers)
        # SC1091: Can't follow sourced files
        if shellcheck -e SC2317,SC1091 -S warning "$script" 2>/dev/null; then
            success "$script"
        else
            warning "$script - shellcheck warnings"
            WARNINGS=$((WARNINGS + 1))
        fi
    fi
done

echo ""

# ============================================================================
# 3. YAML VALIDATION
# ============================================================================

log "Validating YAML files..."

for yaml in src/ansible/**/*.yml src/ansible/**/*.yaml; do
    if [[ -f "$yaml" ]]; then
        if yamllint -d relaxed "$yaml" 2>/dev/null; then
            success "$yaml"
        else
            warning "$yaml - yamllint issues"
            WARNINGS=$((WARNINGS + 1))
        fi
    fi
done

echo ""

# ============================================================================
# 4. ANSIBLE SYNTAX CHECK
# ============================================================================

log "Checking Ansible playbook syntax..."

cd /app/src/ansible

for playbook in playbooks/*.yml; do
    if [[ -f "$playbook" ]]; then
        if ansible-playbook --syntax-check "$playbook" 2>/dev/null; then
            success "$playbook"
        else
            fail "$playbook - syntax error"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

cd /app
echo ""

# ============================================================================
# 5. CONFIGURATION VALIDATION
# ============================================================================

log "Validating configuration templates..."

for config in src/config.env.basic src/config.env.advanced; do
    if [[ -f "$config" ]]; then
        # Check required variables exist
        REQUIRED_VARS="HOSTNAME USERNAME TIMEZONE KERNEL_TYPE TARGET_DISK"
        MISSING=""

        for var in $REQUIRED_VARS; do
            if ! grep -q "^${var}=" "$config"; then
                MISSING="$MISSING $var"
            fi
        done

        if [[ -z "$MISSING" ]]; then
            success "$config"
        else
            fail "$config - missing:$MISSING"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

echo ""

# ============================================================================
# 6. PYTHON TESTS
# ============================================================================

log "Running pytest..."

if pytest tests/ -v --tb=short 2>/dev/null; then
    success "All Python tests passed"
else
    fail "Python tests failed"
    ERRORS=$((ERRORS + 1))
fi

echo ""

# ============================================================================
# 7. DRY-RUN VALIDATION (install.sh)
# ============================================================================

log "Validating install.sh functions..."

# Source install.sh in a subshell to check function definitions
if bash -c '
    set +e
    source /app/src/install.sh --source-only 2>/dev/null

    # Check critical functions exist
    type log &>/dev/null && \
    type error &>/dev/null && \
    type success &>/dev/null && \
    type warning &>/dev/null
' 2>/dev/null; then
    success "install.sh functions valid"
else
    warning "install.sh function check skipped (no --source-only support)"
    WARNINGS=$((WARNINGS + 1))
fi

echo ""

# ============================================================================
# SUMMARY
# ============================================================================

echo "================================================================"
echo "  TEST RESULTS"
echo "================================================================"
echo ""

if [[ $ERRORS -eq 0 ]]; then
    echo -e "  ${GREEN}All critical tests passed!${NC}"
else
    echo -e "  ${RED}Errors: $ERRORS${NC}"
fi

if [[ $WARNINGS -gt 0 ]]; then
    echo -e "  ${YELLOW}Warnings: $WARNINGS${NC}"
fi

echo ""
echo "  Note: This tests syntax and structure only."
echo "  Full installation testing requires VirtualBox or real hardware."
echo ""
echo "================================================================"

exit $ERRORS
TESTSCRIPT

RUN chmod +x /app/run-tests.sh

# Default command
CMD ["/app/run-tests.sh"]
