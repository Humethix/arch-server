# Arch Server v5.1 - GitLab CI/CD Configuration

stages:
  - lint
  - test
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache configuration
cache:
  paths:
    - .cache/pip
    - .venv/

# Default image
default:
  image: python:3.11-slim

# =============================================================================
# LINT STAGE
# =============================================================================

shellcheck:
  stage: lint
  image: koalaman/shellcheck-alpine:stable
  script:
    - shellcheck src/install.sh scripts/*.sh
  rules:
    - changes:
        - "**/*.sh"

yamllint:
  stage: lint
  before_script:
    - pip install yamllint
  script:
    - yamllint -c .yamllint.yml .
  rules:
    - changes:
        - "**/*.yml"
        - "**/*.yaml"

ansible-lint:
  stage: lint
  before_script:
    - pip install ansible ansible-lint
  script:
    - ansible-lint src/ansible/
  rules:
    - changes:
        - "src/ansible/**/*"

markdown-lint:
  stage: lint
  image: node:20-slim
  before_script:
    - npm install -g markdownlint-cli
  script:
    - markdownlint '**/*.md' --disable MD013
  rules:
    - changes:
        - "**/*.md"

# =============================================================================
# TEST STAGE
# =============================================================================

ansible-syntax:
  stage: test
  before_script:
    - pip install ansible
  script:
    - ansible-playbook --syntax-check src/ansible/playbooks/site.yml
    - ansible-playbook --syntax-check src/ansible/playbooks/go-live.yml
  rules:
    - changes:
        - "src/ansible/**/*"

python-tests:
  stage: test
  before_script:
    - pip install -r requirements.txt
  script:
    - pytest tests/ -v
  rules:
    - changes:
        - "tests/**/*"
        - "src/**/*"
  allow_failure: true

# =============================================================================
# BUILD STAGE
# =============================================================================

build-docs:
  stage: build
  before_script:
    - pip install mkdocs mkdocs-material
  script:
    - mkdocs build --site-dir public
  artifacts:
    paths:
      - public
  rules:
    - changes:
        - "docs/**/*"
        - "mkdocs.yml"

create-release:
  stage: build
  script:
    - |
      VERSION=$(grep -m1 "VERSION=" src/install.sh | cut -d'"' -f2 || echo "5.1.0")
      echo "Creating release archive for version $VERSION"
      tar -czvf arch-server-v${VERSION}.tar.gz \
        --exclude='.git' \
        --exclude='.gitlab' \
        --exclude='keys/*' \
        --exclude='*.tar.gz' \
        .
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG

# =============================================================================
# DEPLOY STAGE
# =============================================================================

pages:
  stage: deploy
  script:
    - pip install mkdocs mkdocs-material
    - mkdocs build --site-dir public
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - "docs/**/*"

deploy-release:
  stage: deploy
  script:
    - echo "Deploying release $CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG
  environment:
    name: production
