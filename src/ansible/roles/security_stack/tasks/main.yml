---
# Security Stack for Arch Linux v5.1
# Nftables + AppArmor + Auditd

# ============================================
# NFTABLES FIREWALL
# ============================================

- name: Install nftables
  community.general.pacman:
    name: nftables
    state: present

- name: Deploy main nftables configuration
  copy:
    dest: /etc/nftables.conf
    mode: '0644'
    content: |
      #!/usr/sbin/nft -f
      flush ruleset
      
      table inet filter {
        # Cloudflare IP sets
        set cloudflare_ipv4 {
          type ipv4_addr
          flags interval
          elements = { 173.245.48.0/20, 103.21.244.0/22, 103.22.200.0/22, 103.31.4.0/22, 141.101.64.0/18, 108.162.192.0/18, 190.93.240.0/20, 188.114.96.0/20, 197.234.240.0/22, 198.41.128.0/17, 162.158.0.0/15, 104.16.0.0/13, 104.24.0.0/14, 172.64.0.0/13, 131.0.72.0/22 }
        }
        
        set cloudflare_ipv6 {
          type ipv6_addr
          flags interval
          elements = { 2400:cb00::/32, 2606:4700::/32, 2803:f800::/32, 2405:b500::/32, 2405:8100::/32, 2a06:98c0::/29, 2c0f:f248::/32 }
        }
        
        # Rate limiting sets
        set rate_limit_ssh {
          type ipv4_addr
          flags timeout
        }
        
        set blacklist {
          type ipv4_addr
          flags timeout
        }
        
        chain input {
          type filter hook input priority 0; policy drop;
          
          # Accept established connections
          ct state established,related accept
          ct state invalid drop
          
          # Accept loopback
          iifname "lo" accept
          
          # Drop blacklisted IPs
          ip saddr @blacklist drop
          
          # Rate limited SSH
          ip saddr @rate_limit_ssh drop
          
          # ICMP (rate limited)
          ip protocol icmp icmp type { echo-request, destination-unreachable, time-exceeded } limit rate 10/second accept
          ip6 nexthdr icmpv6 icmpv6 type { echo-request, echo-reply, nd-neighbor-solicit, nd-neighbor-advert, nd-router-solicit, nd-router-advert } limit rate 10/second accept
          
          # SSH (rate limited - 3 new connections per minute per IP)
          tcp dport 22 ct state new limit rate 3/minute accept
          tcp dport 22 ct state new add @rate_limit_ssh { ip saddr timeout 10m } drop
          
          # Web traffic - allow from Cloudflare IPs
          tcp dport { 80, 443 } ip saddr @cloudflare_ipv4 accept
          tcp dport { 80, 443 } ip6 saddr @cloudflare_ipv6 accept
          udp dport 443 ip saddr @cloudflare_ipv4 accept
          udp dport 443 ip6 saddr @cloudflare_ipv6 accept
          
          # Also allow direct web access for testing (remove after tunnel setup)
          tcp dport { 80, 443 } accept
          
          # Container networking
          iifname "podman*" accept
          iifname "cni-*" accept
          
          # Log dropped packets (rate limited)
          limit rate 5/minute log prefix "nftables-drop: " level info
        }
        
        chain forward {
          type filter hook forward priority 0; policy drop;
          
          # Allow container traffic
          ct state established,related accept
          iifname "podman*" accept
          oifname "podman*" accept
        }
        
        chain output {
          type filter hook output priority 0; policy accept;
        }
      }
  notify: Restart nftables

- name: Ensure nftables directory exists
  file:
    path: /etc/nftables.d
    state: directory
    mode: '0755'

- name: Force handlers to run now
  meta: flush_handlers

- name: Enable and start nftables
  systemd:
    name: nftables
    enabled: yes
    state: started
    daemon_reload: yes
  register: nftables_start

- name: Wait for nftables to initialize
  pause:
    seconds: 2

- name: Force nftables rules load
  command: nft -f /etc/nftables.conf
  register: nftables_load
  failed_when: false
  changed_when: false

- name: Verify nftables rules are loaded
  shell: nft list ruleset 2>/dev/null | grep -q "table"
  register: nftables_rules
  changed_when: false
  failed_when: false

- name: Get nftables failure reason if rules not loaded
  command: journalctl -u nftables --no-pager -n 10
  register: nftables_journal
  changed_when: false
  failed_when: false
  when: nftables_rules.rc != 0

- name: Test nftables config syntax
  command: nft -c -f /etc/nftables.conf
  register: nftables_syntax
  changed_when: false
  failed_when: false
  when: nftables_rules.rc != 0

- name: Debug nftables failure
  debug:
    msg:
      - "nftables rules loaded: {{ 'YES' if nftables_rules.rc == 0 else 'NO' }}"
      - "Config syntax check: {{ 'OK' if nftables_syntax.rc == 0 else nftables_syntax.stderr | default('failed') }}"
      - "Load command: {{ 'OK' if nftables_load.rc == 0 else nftables_load.stderr | default('failed') }}"
      - "Journal: {{ nftables_journal.stdout_lines | default(['no logs']) }}"
  when: nftables_rules.rc != 0

- name: Try to restart nftables service if rules not loaded
  systemd:
    name: nftables
    state: restarted
  register: nftables_restart
  failed_when: false
  when: nftables_rules.rc != 0

- name: Wait after restart
  pause:
    seconds: 3
  when: nftables_rules.rc != 0

- name: Final nftables rules check
  shell: nft list ruleset 2>/dev/null | grep -q "table"
  register: nftables_final
  changed_when: false
  failed_when: false

- name: Report nftables status
  debug:
    msg: "{{ '✓ nftables firewall rules LOADED' if nftables_final.rc == 0 else '⚠ nftables rules not loaded - check config/logs' }}"

# ============================================
# APPARMOR
# ============================================

- name: Install AppArmor
  community.general.pacman:
    name: apparmor
    state: present

- name: Enable AppArmor service
  systemd:
    name: apparmor
    enabled: yes
    state: started
  failed_when: false

- name: Note about AppArmor kernel parameters
  debug:
    msg:
      - "AppArmor enabled as systemd service."
      - "For full enforcement, add to kernel cmdline:"
      - "  lsm=landlock,lockdown,yama,integrity,apparmor,bpf"
      - ""
      - "Since we use systemd-boot (not GRUB), edit:"
      - "  /etc/kernel/cmdline"
      - "Then regenerate UKI: mkinitcpio -P"

# ============================================
# AUDITD
# ============================================

- name: Install auditd
  community.general.pacman:
    name: audit
    state: present

- name: Deploy audit rules
  copy:
    dest: /etc/audit/rules.d/hardening.rules
    mode: '0640'
    content: |
      # Audit rules for security monitoring
      # Arch Linux v5.1
      
      # Delete all existing rules
      -D
      
      # Buffer size
      -b 8192
      
      # Failure mode (1 = print, 2 = panic)
      -f 1
      
      # Identity changes
      -w /etc/passwd -p wa -k identity
      -w /etc/group -p wa -k identity
      -w /etc/shadow -p wa -k identity
      -w /etc/gshadow -p wa -k identity
      -w /etc/sudoers -p wa -k identity
      -w /etc/sudoers.d/ -p wa -k identity
      
      # Network configuration
      -w /etc/hosts -p wa -k network
      -w /etc/NetworkManager/ -p wa -k network
      
      # SSH configuration
      -w /etc/ssh/sshd_config -p wa -k sshd
      
      # Privilege escalation
      -w /usr/bin/sudo -p x -k sudo_usage
      -w /usr/bin/su -p x -k su_usage
      
      # Kernel module loading
      -w /sbin/insmod -p x -k modules
      -w /sbin/rmmod -p x -k modules
      -w /sbin/modprobe -p x -k modules
      
      # Make rules immutable (requires reboot to change)
      # Commented out during testing
      # -e 2

- name: Enable auditd
  systemd:
    name: auditd
    enabled: yes
    state: started

# ============================================
# AIDE (File Integrity - AUR notice)
# ============================================

- name: Check if AIDE is installed
  command: pacman -Q aide
  register: aide_installed
  failed_when: false
  changed_when: false

- name: AIDE notice
  debug:
    msg:
      - "AIDE (File Integrity Monitoring) is in the AUR."
      - "To install: yay -S aide"
      - "Then run: aide --init && mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz"
  when: aide_installed.rc != 0

- name: Security stack complete
  debug:
    msg: "✓ Security stack configured (nftables + AppArmor + auditd)"
