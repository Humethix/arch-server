---
# Monitoring Role for Arch Linux v5.1
# Basic monitoring tools from official repos

- name: Install monitoring tools
  community.general.pacman:
    name:
      - htop
      - iotop
      - iftop
      - lsof
      - strace
      - sysstat
      - net-tools
      - bind-tools
    state: present

# Prometheus Node Exporter (official package)
- name: Install Prometheus Node Exporter
  community.general.pacman:
    name: prometheus-node-exporter
    state: present
  when: monitoring_node_exporter | default(false) | bool

- name: Enable Node Exporter service
  systemd:
    name: prometheus-node-exporter
    enabled: yes
    state: started
  when: monitoring_node_exporter | default(false) | bool

# Prometheus server (optional - from AUR)
- name: Check if Prometheus is requested
  when: monitoring_prometheus | default(false) | bool
  block:
    - name: Prometheus notice (AUR package)
      debug:
        msg:
          - "Prometheus is in AUR - install manually:"
          - "yay -S prometheus"
          - ""
          - "Or use Docker: podman run -d -p 9090:9090 prom/prometheus"
          - ""
          - "Configuration: /etc/prometheus/prometheus.yml"

    - name: Create Prometheus configuration directory
      file:
        path: /etc/prometheus
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Deploy Prometheus configuration
      template:
        src: prometheus.yml.j2
        dest: /etc/prometheus/prometheus.yml
        mode: '0644'
        owner: root
        group: root

# Grafana (optional - from AUR)
- name: Check if Grafana is requested
  when: monitoring_grafana | default(false) | bool
  block:
    - name: Grafana notice (AUR package)
      debug:
        msg:
          - "Grafana is in AUR - install manually:"
          - "yay -S grafana"
          - ""
          - "Or use Docker: podman run -d -p 3000:3000 grafana/grafana"
          - ""
          - "Dashboard JSON: /etc/grafana/provisioning/dashboards/arch-server-dashboard.json"

    - name: Create Grafana dashboards directory
      file:
        path: /etc/grafana/provisioning/dashboards
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Deploy Grafana dashboard
      copy:
        src: grafana-dashboard.json
        dest: /etc/grafana/provisioning/dashboards/arch-server-dashboard.json
        mode: '0644'
        owner: root
        group: root

# Basic monitoring dashboard (text-based)
- name: Create monitoring dashboard script
  copy:
    dest: /usr/local/bin/monitoring-dashboard
    mode: '0755'
    content: |
      #!/bin/bash
      # Simple monitoring dashboard for Arch Server v5.1

      echo "=========================================="
      echo "  ARCH SERVER v5.1 - MONITORING DASHBOARD"
      echo "=========================================="
      echo

      # System info
      echo "SYSTEM INFO:"
      echo "  Hostname: $(hostname)"
      echo "  Uptime:   $(uptime -p)"
      echo "  Load:     $(uptime | awk -F'load average:' '{print $2}' | xargs)"
      echo

      # CPU and Memory
      echo "RESOURCE USAGE:"
      echo "  CPU:      $(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}')"
      free -h | grep -E "^(Mem|Swap)" | awk '{print "  " $1 ":     " $3 "/" $2 " (" int($3/$2*100) "%)"}'
      echo

      # Disk usage
      echo "DISK USAGE:"
      df -h / | tail -1 | awk '{print "  Root:     " $3 "/" $2 " (" $5 " used)"}'
      echo

      # Services status
      echo "SERVICE STATUS:"
      for service in caddy sshd apparmor auditd; do
          if systemctl is-active $service &>/dev/null; then
              echo "  $service:    ✓ Running"
          else
              echo "  $service:    ✗ Stopped"
          fi
      done
      echo

      # Security status
      echo "SECURITY STATUS:"
      if [ -e /dev/tpm0 ] || [ -e /dev/tpmrm0 ]; then
          echo "  TPM:       ✓ Available"
      else
          echo "  TPM:       ✗ Not found"
      fi

      if mokutil --sb-state 2>/dev/null | grep -q "SecureBoot enabled"; then
          echo "  SecureBoot: ✓ Enabled"
      else
          echo "  SecureBoot: ✗ Disabled"
      fi

      if lsblk -o TYPE | grep -q "crypt"; then
          echo "  LUKS:      ✓ Active"
      else
          echo "  LUKS:      ✗ Not active"
      fi
      echo

      # Recent logs
      echo "RECENT LOGS (last 5 entries):"
      journalctl -n 5 --no-pager -q | head -5 | sed 's/^/  /'
      echo

      # Network info
      echo "NETWORK INFO:"
      ip route get 1.1.1.1 2>/dev/null | head -1 | awk '{print "  Gateway:  " $3}'
      echo "  DNS:      $(grep nameserver /etc/resolv.conf | head -1 | awk '{print $2}')"
      echo

# Fluent Bit is in AUR - provide notice
- name: Check if Fluent Bit is installed
  command: pacman -Q fluent-bit
  register: fluentbit_installed
  failed_when: false
  changed_when: false

- name: Fluent Bit notice
  debug:
    msg:
      - "Fluent Bit is NOT in official Arch repositories."
      - "To install from AUR: yay -S fluent-bit"
      - ""
      - "Alternative: Use journald for log aggregation"
      - "View logs: journalctl -f"
  when: fluentbit_installed.rc != 0

- name: Configure Fluent Bit (if installed)
  when: fluentbit_installed.rc == 0
  block:
    - name: Deploy Fluent Bit configuration
      copy:
        dest: /etc/fluent-bit/fluent-bit.conf
        mode: '0644'
        content: |
          [SERVICE]
              Flush        5
              Daemon       Off
              Log_Level    info
              
          [INPUT]
              Name systemd
              Tag  host.*
              Read_From_Tail On
              
          [FILTER]
              Name grep
              Match host.*
              Regex log (error|critical|alert|emergency|fail|denied)
              
          [OUTPUT]
              Name  stdout
              Match *
              Format json_lines

    - name: Enable Fluent Bit
      systemd:
        name: fluent-bit
        enabled: yes
        state: started

# Setup journald for efficient log storage
- name: Create journald conf directory
  file:
    path: /etc/systemd/journald.conf.d
    state: directory
    mode: '0755'

- name: Configure journald
  copy:
    dest: /etc/systemd/journald.conf.d/server.conf
    mode: '0644'
    content: |
      [Journal]
      # Persistent storage
      Storage=persistent
      
      # Compression
      Compress=yes
      
      # Size limits
      SystemMaxUse=500M
      SystemMaxFileSize=50M
      RuntimeMaxUse=100M
      
      # Forward to syslog for compatibility
      ForwardToSyslog=no
  notify: Restart journald

- name: Enable sysstat collection
  systemd:
    name: sysstat
    enabled: yes
    state: started
  failed_when: false

- name: Monitoring complete
  debug:
    msg: "✓ Monitoring tools installed (htop, iotop, sysstat)"
